<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalle de Serie</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #backdrop {
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .image-loader {
      position: relative;
      overflow: hidden;
      background: #1f2937;
    }

    .image-loader::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.25) 50%, rgba(255,255,255,0.1) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite linear;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .fade-in {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .fade-in.show {
      opacity: 1;
      transform: translateY(0);
    }

    .popup-anim {
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s ease;
    }

    .popup-anim.show {
      opacity: 1;
      transform: scale(1);
    }

    .text-ellipsis-2 {
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    button.episode-disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    a.download-disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    /* Nuevo estilo para el texto debajo del botón de temporada */
    #ultimoVisto {
      margin-top: 0.25rem;
      color: #8b5cf6; /* color morado */
      font-weight: 600;
      font-size: 0.875rem;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    #ultimoVisto.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body class="bg-black text-white font-sans">

  <div id="backdrop" class="relative h-[450px] w-full image-loader">
    <div class="absolute bottom-0 left-0 right-0 h-80 bg-gradient-to-t from-black to-transparent z-10"></div>
  </div>

  <div class="flex justify-center -mt-60 z-30 relative fade-in">
    <div class="h-24 w-48 rounded image-loader" id="logo-container">
      <img id="logo" class="h-24 object-contain hidden" alt="Logo de la serie"/>
    </div>
  </div>

  <div class="p-4 max-w-xl mx-auto z-20 relative fade-in">
    <h1 id="title" class="text-2xl font-bold mb-1">Cargando...</h1>
    <div id="meta" class="flex items-center space-x-2 text-sm mb-1 text-gray-300">
      <span id="year">----</span>
      <span class="bg-gray-700 px-2 rounded text-white">TV-MA</span>
      <span id="seasons">-- temporadas</span>
    </div>

    <div class="text-sm text-red-500 font-semibold mb-3 flex items-center gap-1">
      <i data-lucide="flame" class="w-4 h-4"></i>
      N.º 6 en TV hoy
    </div>

    <div class="space-y-2">
      <button id="btnVer" class="w-full bg-white text-black font-bold py-2 rounded flex justify-center items-center gap-2 transition hover:bg-gray-300">
        <i data-lucide="play" class="w-5 h-5"></i> Ver
      </button>
      <button id="btnDescargar" class="w-full bg-gray-800 border border-white text-white font-medium py-2 rounded flex justify-center items-center gap-2 transition hover:bg-gray-700">
        <i data-lucide="download" class="w-5 h-5"></i> Descargar
      </button>
    </div>

    <p id="overview" class="text-sm text-gray-400 mt-4 line-clamp-1"></p>
    <p class="text-sm text-gray-500 mt-2 line-clamp-3"><strong>Protagonistas:</strong> <span id="cast">Cargando...</span></p>
    <p class="text-sm text-gray-500 mt-2 line-clamp-3"><strong>Creado por:</strong> <span id="creators">Cargando...</span></p>
    <p class="text-sm text-gray-500 mt-2 line-clamp-3"><strong>Géneros:</strong> <span id="genres">Cargando...</span></p>

    <div class="flex items-center justify-around mt-5 text-xs text-gray-300 relative space-x-4">
      <button id="btnMiLista" class="flex flex-col items-center transform transition-transform duration-200 hover:scale-105 hover:shadow-lg" onclick="toggleLista()">
        <i id="iconMiLista" data-lucide="plus" class="w-5 h-5 mb-1"></i> Mi Lista
      </button>
      <button id="btnCalificar" class="flex flex-col items-center transform transition-transform duration-200 hover:scale-105 hover:shadow-lg" onclick="mostrarPopupCalificar()">
        <i id="iconCalificar" data-lucide="thumbs-up" class="w-5 h-5 mb-1"></i> Calificar
      </button>
      <button class="flex flex-col items-center transform transition-transform duration-200 hover:scale-105 hover:shadow-lg" onclick="window.location.href='http://action_share'">
        <i data-lucide="share-2" class="w-5 h-5 mb-1"></i> Compartir
      </button>
    </div>

    <div class="my-4 h-px bg-gray-600"></div>

    <div class="w-full flex mb-2">
      <button id="btnEpisodios" class="w-1/2 text-center py-2 border-b-2 border-transparent text-white font-medium transition">Capítulos</button>
      <button id="btnTrailers" class="w-1/2 text-center py-2 border-b-2 border-transparent text-white font-medium transition">Tráilers</button>
    </div>

    <div class="relative mb-1">
      <button id="btnTemporadas" class="w-full bg-gray-800 border border-gray-700 py-2 rounded flex justify-between items-center text-white hover:bg-gray-700">
        <span id="temporadaSeleccionada">Temporada 1</span>
        <i data-lucide="chevron-down" class="w-5 h-5"></i>
      </button>
      <div id="ultimoVisto"></div>
      <div id="listaTemporadas" class="absolute top-full mt-1 w-full bg-gray-900 rounded shadow-lg hidden z-20"></div>
    </div>

    <div id="contenidoEpisodios" class="text-sm text-gray-300"></div>
    <div id="contenidoTrailers" class="text-sm text-gray-300 hidden"></div>
  </div>

  <script>
    // URLs para reproducción
    const episodeUrls = {
      "1": {
        "1": "",
        "2": "",
        "3": "",
        "4": "",
        "5": "",
        "6": "",
        "7": "",
        "8": "",
        "9": "",
        "10": "",
        "11": "",
        "12": "",
        "13": "",
        "14": "",
        "15": "",
        "16": "",
        "17": "",
        "18": "",
        "19": "",
        "20": "",
        "21": "",
        "22": "",
        "23": "",
        "24": "",
        "25": "",
        "26": "",
        "27": "",
        "28": "",
        "29": "",
        "30": "",
        "31": "",
        "31": "",
        "32": "",
        "33": "",
        "34": "",
        "35": "",
        "36": "",
        "37": "",
        "38": "",
        "39": "",
        "40": "",
        "41": "",
        "42": "",
        "43": "",
        "44": "",
        "45": "",
        "46": "",
        "47": "",
        "48": "",
        "49": "",
        "50": "",
        "51": "",
        "52": "",
        "53": "",
        "54": "",
        "55": "",
        "56": "",
        "57": "",
        "58": "",
        "59": "",
        "60": "",
        "61": "",
        "62": "",
        "63": "",
        "64": "",
        "65": "",
        "66": "",
        "67": "",
        "68": "",
        "69": "",
        "70": "",
        "71": "",
        "72": "",
        "73": "",
        "74": "",
        "75": "",
        "76": "",
        "77": "",
        "78": "",
        "79": "",
        "80": "",
        "81": "",
        "82": "",
        "83": "",
        "84": "",
        "85": "",
        "86": "",
        "87": "",
        "88": "",
        "89": "",
        "90": "",
        "91": "",
        "92": "",
        "93": "",
        "94": "",
        "95": "",
        "96": "",
        "97": "",
        "98": "",
        "99": "",
        "100": "",
        "101": "",
        "102": "",
        "103": "",
        "104": "",
        "105": "",
        "106": "",
        "107": "",
        "108": "",
        "109": "",
        "110": "",
        "111": "",
        "112": "",
        "113": "",
        "114": "",
        "115": "",
        "116": "",
        "117": "",
        "118": "",
        "119": "",
        "120": "",
        "121": "",
        "122": "",
        "123": "",
        "124": "",
        "125": "",
        "126": "",
        "127": "",
        "128": "",
        "129": "",
        "130": "",
        "131": "",
        "131": "",
        "132": "",
        "133": "",
        "134": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=2tx7sg",
        "135": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=hq8m1b",
        "136": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=lhd4v6",
        "137": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=4umsai",
        "138": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=oqqhhi",
        "139": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=oa9fb4",
        "140": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=da1mbe",
        "141": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=2st4ag",
        "142": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=yi8tmn",
        "143": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=ah1n0d",
        "144": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=q6u1ao",
        "145": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=p6akj3",
        "146": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=luiuig",
        "147": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=kg3egt",
        "148": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=6ntjs0",
        "149": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=svd3he",
        "150": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=jwj2x9",
        "151": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=3unarc",
        "152": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=4dmgdc",
        "153": "https://nimeapp.github.io/Acortadorurl/redirect.html?c=od9bri",
        
        
      },
    };

    // URLs para descarga
    const episodeDownloadUrls = {
      "1": {
        "1": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        "2": "",
        
      
      },
    };

    const btnEpisodios = document.getElementById('btnEpisodios');
    const btnTrailers = document.getElementById('btnTrailers');
    const btnTemporadas = document.getElementById('btnTemporadas');
    const listaTemporadas = document.getElementById('listaTemporadas');
    const temporadaSeleccionada = document.getElementById('temporadaSeleccionada');
    const contenidoEpisodios = document.getElementById('contenidoEpisodios');
    const contenidoTrailers = document.getElementById('contenidoTrailers');
    const btnVer = document.getElementById('btnVer');
    const btnDescargar = document.getElementById('btnDescargar');
    const ultimoVistoDiv = document.getElementById('ultimoVisto');
    const btnMiLista = document.getElementById('btnMiLista');
    const iconMiLista = document.getElementById('iconMiLista');

    let numeroTemporadas = 1;
    let fechaEstreno = '';
    const API_KEY = 'f91aff7a5c1524c5db2d8b5864747dd6';
    //REMPLACE ID
    const SERIES_ID = 12609;


    const LS_KEY = `serie_${SERIES_ID}_ultimo_visto`;
    const LS_MI_LISTA_KEY = `serie_${SERIES_ID}_mi_lista`;

    function activarTab(tab) {
      const activoClass = ['border-purple-500', 'text-purple-500'];
      const inactivoClass = ['border-transparent', 'text-white'];

      if (tab === 'episodios') {
        btnEpisodios.classList.add(...activoClass);
        btnEpisodios.classList.remove(...inactivoClass);
        btnTrailers.classList.remove(...activoClass);
        btnTrailers.classList.add(...inactivoClass);
        contenidoEpisodios.classList.remove('hidden');
        contenidoTrailers.classList.add('hidden');
      } else {
        btnTrailers.classList.add(...activoClass);
        btnTrailers.classList.remove(...inactivoClass);
        btnEpisodios.classList.remove(...activoClass);
        btnEpisodios.classList.add(...inactivoClass);
        contenidoTrailers.classList.remove('hidden');
        contenidoEpisodios.classList.add('hidden');
        cargarTrailers();
      }
    }

    btnEpisodios.addEventListener('click', () => activarTab('episodios'));
    btnTrailers.addEventListener('click', () => activarTab('trailers'));
    btnTemporadas.addEventListener('click', () => listaTemporadas.classList.toggle('hidden'));

    btnVer.addEventListener('click', () => {

      const ultimo = leerUltimoVisto();
      if (ultimo) {
        irAReproducir(ultimo.temporada, ultimo.episodio);
      } else {

        irAReproducir(1,1);
      }
    });

    btnMiLista.addEventListener('click', toggleLista);

    async function cargarTodo() {
      await cargarSerie();
      await cargarTemporadas();

      let ultimo = leerUltimoVisto();
      if (ultimo) {
        temporadaSeleccionada.textContent = `Temporada ${ultimo.temporada}`;
        await cargarEpisodios(ultimo.temporada);
      } else {
        temporadaSeleccionada.textContent = `Temporada 1`;
        await cargarEpisodios(1);
      }
      actualizarBotonVer();
      actualizarUltimoVistoTexto();
      actualizarMiListaIcon();
      lucide.createIcons();
      document.querySelectorAll('.fade-in').forEach(el => el.classList.add('show'));
    }

    function guardarUltimoVisto(temporada, episodio) {
      localStorage.setItem(LS_KEY, JSON.stringify({ temporada, episodio }));
    }
    function leerUltimoVisto() {
      const data = localStorage.getItem(LS_KEY);
      if (!data) return null;
      try {
        return JSON.parse(data);
      } catch {
        return null;
      }
    }

    function guardarMiLista(agregado) {
      localStorage.setItem(LS_MI_LISTA_KEY, agregado ? '1' : '0');
    }
    function leerMiLista() {
      return localStorage.getItem(LS_MI_LISTA_KEY) === '1';
    }

    function actualizarMiListaIcon() {
      const agregado = leerMiLista();
      iconMiLista.setAttribute('data-lucide', agregado ? 'check' : 'plus');
      lucide.createIcons();
    }

    function toggleLista() {
      const agregado = leerMiLista();
      guardarMiLista(!agregado);
      actualizarMiListaIcon();
    }

    function actualizarBotonVer() {
      const ultimo = leerUltimoVisto();
      if (!ultimo) {
        btnVer.innerHTML = `<i data-lucide="play" class="w-5 h-5"></i> Ver`;
      } else {

        if (ultimo.temporada > 1 || ultimo.episodio > 1) {
          btnVer.innerHTML = `<i data-lucide="play" class="w-5 h-5"></i> Continuar`;
        } else {
          btnVer.innerHTML = `<i data-lucide="play" class="w-5 h-5"></i> Ver`;
        }
      }
      lucide.createIcons();
    }

    function actualizarUltimoVistoTexto() {
      const ultimo = leerUltimoVisto();
      if (!ultimo) {
        ultimoVistoDiv.textContent = '';
        ultimoVistoDiv.classList.remove('show');
        return;
      }
      ultimoVistoDiv.textContent = `Último episodio visto: Temporada ${ultimo.temporada}, Episodio ${ultimo.episodio}`;
      ultimoVistoDiv.classList.add('show');
    }

    async function cargarSerie() {
      const res = await fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}?api_key=${API_KEY}&language=es-ES`);
      const data = await res.json();
      document.getElementById('title').textContent = data.name;
      document.getElementById('year').textContent = data.first_air_date?.slice(0, 4) || '---';
      fechaEstreno = data.first_air_date || 'Fecha no disponible';
      document.getElementById('seasons').textContent = `${data.number_of_seasons} temporada${data.number_of_seasons > 1 ? 's' : ''}`;
      numeroTemporadas = data.number_of_seasons;

      const backdrop = document.getElementById('backdrop');
      if (data.backdrop_path) {
        const img = new Image();
        img.src = `https://image.tmdb.org/t/p/original${data.backdrop_path}`;
        img.onload = () => {
          backdrop.style.backgroundImage = `url(${img.src})`;
          backdrop.classList.remove('image-loader');
        };
      }

      const logoRes = await fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}/images?api_key=${API_KEY}`);
      const logoData = await logoRes.json();
      const logo = logoData.logos.find(l => l.iso_639_1 === 'es') || logoData.logos[0];
      const logoEl = document.getElementById('logo');
      if (logo) {
        logoEl.src = `https://image.tmdb.org/t/p/original${logo.file_path}`;
        logoEl.onload = () => {
          logoEl.classList.remove('hidden');
          document.getElementById('logo-container').classList.remove('image-loader');
        };
      } else {
        document.getElementById('logo-container').style.display = 'none';
      }

      const castRes = await fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}/credits?api_key=${API_KEY}&language=es-ES`);
      const castData = await castRes.json();
      document.getElementById('cast').textContent = castData.cast.slice(0, 4).map(a => a.name).join(', ') + '...';
      document.getElementById('creators').textContent = data.created_by?.map(c => c.name).join(', ') || 'No disponible';
      document.getElementById('genres').textContent = data.genres?.map(g => g.name).join(', ') || 'No disponible';
      document.getElementById('overview').textContent = data.overview || 'Sin descripción disponible.';
    }

    async function cargarTemporadas() {
      listaTemporadas.innerHTML = '';
      for (let i = 1; i <= numeroTemporadas; i++) {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left px-3 py-2 hover:bg-gray-700';
        btn.textContent = `Temporada ${i}`;
        btn.onclick = async () => {
          temporadaSeleccionada.textContent = `Temporada ${i}`;
          listaTemporadas.classList.add('hidden');
          await cargarEpisodios(i);
          actualizarUltimoVistoTexto();
          actualizarBotonVer();
        };
        listaTemporadas.appendChild(btn);
      }
    }

    async function cargarEpisodios(numTemporada) {
      const res = await fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}/season/${numTemporada}?api_key=${API_KEY}&language=es-ES`);
      const data = await res.json();
      let html = '';

      data.episodes.forEach(ep => {
        const tieneUrl = episodeUrls[numTemporada] && episodeUrls[numTemporada][ep.episode_number];
        const tieneDescarga = episodeDownloadUrls[numTemporada] && episodeDownloadUrls[numTemporada][ep.episode_number];

        html += `
        <div class="flex items-start gap-3 mb-6 w-full rounded-lg text-left
            ${tieneUrl ? 'cursor-pointer' : 'opacity-50 cursor-not-allowed'}"
          >
          <button
            class="flex-1 flex items-start gap-3 p-3 rounded-lg
              ${tieneUrl ? 'bg-white/5 hover:bg-white/10' : 'bg-white/10'}"
            ${tieneUrl ? `onclick="irAReproducir(${numTemporada}, ${ep.episode_number})"` : 'disabled'}
            title="${tieneUrl ? 'Ver episodio' : 'Episodio no disponible'}"
          >
            <div class="relative w-24 h-16 flex-shrink-0 rounded overflow-hidden image-loader">
              <img src="https://image.tmdb.org/t/p/w300${ep.still_path}" alt="${ep.name}" class="w-full h-full object-cover hidden" onload="this.classList.remove('hidden'); this.parentNode.classList.remove('image-loader');">
              <div class="absolute inset-0 flex items-center justify-center bg-black/40">
                <i data-lucide="${tieneUrl ? 'play' : 'lock'}" class="w-5 h-5 text-white"></i>
              </div>
            </div>
            <div class="flex-1">
              <div class="flex items-start justify-between">
                <div>
                  <h3 class="text-white font-semibold text-sm text-ellipsis-2">${ep.episode_number}. ${ep.name}</h3>
                  <p class="text-xs text-gray-300">${ep.runtime || '--'} min</p>
                </div>
              </div>
              <p class="text-sm text-gray-300 mt-1 text-ellipsis-2">${ep.overview || 'Sin descripción disponible.'}</p>
            </div>
          </button>
          <a
            href="${tieneDescarga ? episodeDownloadUrls[numTemporada][ep.episode_number] : '#'}"
            download
            class="flex items-center px-3 text-white hover:text-green-400 ${tieneDescarga ? '' : 'download-disabled'}"
            title="${tieneDescarga ? 'Descargar episodio' : 'Descarga no disponible'}"
            ${tieneDescarga ? '' : 'aria-disabled="true"'}
            >
            <i data-lucide="download" class="w-5 h-5"></i>
          </a>
        </div>`;
      });

      contenidoEpisodios.innerHTML = html;
      lucide.createIcons();
    }

    function irAReproducir(temporada, episodio) {

  guardarUltimoVisto(temporada, episodio);
  actualizarBotonVer();
  actualizarUltimoVistoTexto();


  const urlPersonalizada = episodeUrls[temporada]?.[episodio];

  if (urlPersonalizada) {

    window.location.href = urlPersonalizada;
  } else {

    window.location.href = `reproducir.html?temporada=${temporada}&episodio=${episodio}`;
  }
}


    async function cargarTrailers() {
      const res = await fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}/videos?api_key=${API_KEY}&language=es-ES`);
      const data = await res.json();
      let html = `<p class="mb-3 text-gray-400">Fecha de estreno: ${fechaEstreno}</p>`;
      if (data.results.length === 0) {
        html += `<p>No hay vídeos disponibles.</p>`;
      } else {
        const grouped = {};
        data.results.forEach(video => {
          if (video.site === 'YouTube' || video.site === 'Vimeo') {
            if (!grouped[video.type]) grouped[video.type] = [];
            grouped[video.type].push(video);
          }
        });
        for (const type in grouped) {
          html += `<h4 class="text-xl font-semibold mb-2 mt-4">${type}</h4>`;
          grouped[type].forEach(video => {
            html += `
              <div class="mb-6">
                <h5 class="text-lg font-semibold mb-2">${video.name}</h5>
                <div class="aspect-w-16 aspect-h-9">
                  <iframe class="w-full rounded-lg" src="https://${video.site === 'YouTube' ? 'www.youtube.com/embed/' : 'player.vimeo.com/video/'}${video.key}" frameborder="0" allowfullscreen></iframe>
                </div>
              </div>`;
          });
        }
      }
      contenidoTrailers.innerHTML = html;
    }

    function mostrarPopupCalificar() {
      const popup = document.getElementById('popupCalificar');
      if (!popup) {
        alert('Funcionalidad de calificar pendiente de implementar.');
        return;
      }
      popup.classList.toggle('hidden');
      if (!popup.classList.contains('hidden')) {
        setTimeout(() => popup.classList.add('show'), 10);
      } else {
        popup.classList.remove('show');
      }
    }

    cargarTodo();
  </script>
</body>
</html>
